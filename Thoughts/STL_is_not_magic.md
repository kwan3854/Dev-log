# C++ STL 은 마법이 아니다

최근 문득 STL 에서 제공하는 vector에 대해 의문이 들었다.

많은 글에서 모던 C++ 을 사용한다면, array 사용을 '지양'하고 vector 사용을 '지향'하라는 말을 보았다.

이는 단순히 사용자 (개발자) 측면에서 보면 정말 편리한 말이 아닐 수 없다.

나는 아무 고민 없이 STL 을 갖다 쓰면 되는거니까.

그러나 이런 의문이 들 수 밖에 없었다.

vector 는 내부적으로 array 를 사용하고 이를 동적으로 할당해가며 사용하는데,

과연 마법처럼 모든 상황에서 문제없이 의도한 대로 동작할까?

- 성능?

  분명 array 보다 나쁘면 나빴지 좋을 순 없다. (내부적으로 array 사용하니까)

  그러나 만약 잘 동작만 한다면 동적 배열 생성이라는 커다란 이점을 주니 어느정도 용서해 줄 수 있다.

- 안전성?

  그런데 만약 안전성에도 문제가 있다면?

  솔직히 이것에 대해서는 의심해 본적이 없었다.

만약 안전성에 이슈가 있다면 이것은 큰 문제이다.

최근 한 게임업계 현업자 분의 stl 에 대한 이야기를 보고 안전성에도 문제가 생길 수 있음을 알게되었다.

[유튜브 영상: "마법없는 코딩, STL, 언리얼 엔진 등"]( https://youtu.be/SitesHL-fAY)

이 분의 말씀은 **모든 시스템이 가상메모리 지원을 완벽하게 해 줄것이라 생각하지 말라** 는 것이다.

나는 놀라지 않을 수 없었다.

OS 에 대해 공부하면서 당연히 모던 시스템들은 다 가상메모리를 제대로 지원할것이라 믿었던 것이다.

이 분의 말씀에 따르면, 비교적 최근(?)의 xbox360 만해도 가상메모리 지원에 문제가 있었다고 한다.

---

### 그래서 어떤 문제가 발생 가능한가?

STL vector 는 일정 크기의 array를 일단 받아오고 그 크기가 넘으면, 새로 array를 동적할당해 오는 방식이다.

이 방식은 잘 동작할 것이다. **가상메모리 지원만 완벽하다면!**

만약 가상메모리 지원에 문제가 있다면, **메모리 파편화(fragmentation)** 가 생길 수 있다. 

**더 큰 문제** 는 이것이다.

STL을 사용해 게임을 개발할때 PC에서는 제대로 동작했다. (가상메모리 지원이 잘 되어서)

그런데 엠베디드 시스템에 포팅하는 과정에서 문제가 발생한다면?

코드 베이스를 다 엎어야 한다.

**제일 큰 문제** 는 아직도 남아있다.

메모리 파편화가 되어서 게임이 뻗을 때 까지 시간이 걸린다는 점이다.

만약 10시간 이상 게임을 해야 게임이 뻗는다면?

그 이전까지는 아무런 문제 없이 잘 동작한다면?

버그가 없다고 판단해 게임을 출시 했는데 출시 후 항의가 빗발친다면?

악몽과도 같다.

---

그래서 의식있는 개발자들은 스스로 컨테이너를 만들어 사용한다고 한다.

그 중 오픈소스로 공개된 EA stl, Unreal Engine 등을 살펴볼 필요가 있을 것 같다.

추후 위 코드들을 살펴보고 글을 계속 작성하겠다.

-2021.05.16-

